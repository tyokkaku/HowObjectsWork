# 13章 関数型言語でなぜつくるのか

## 関数型言語の7つの特徴

純粋関数型言語

1. 関数でプログラムを組み上げる
2. すべての式が値を返す
3. 関数を値として扱える
4. 関数と引数を柔軟に組み合わせることができる
5. 副作用を起こさない
6. 場合分けと再帰でループ処理を記述する
7. コンパイラが型を自動的に推測する

## 特徴1 関数でプログラムを組み上げる

- 関数型言語では、関数の実行を「引数に関数を適用する」と表現する。重要。

- オブジェクト指向設計：サブルーチンと変数をひとまとめにした「クラス」を使ってプログラムを組み上げる
- 関数型プログラミング：関数を使ってプログラムを組み上げる

- 従来の言語と関数型言語では定義に重要な違いがある
  - 従来のプログラミング言語： ひとまとまりの手続き。
  - 関数型言語： y = f(x)

- 「関数を使用する」の表現
  - 命令型： 引数を指定して関数を「呼び出す」
  - 関数型： 引数に関数を「適用」する

## 特徴2 すべての式が値を返す

- 関数型言語は式から成り立つ。式を評価すると値が返る
- 関数の戻り値は最後に評価した式の値になる。このため一般的に関数型言語にはreturnステートメントがない
- 関数型言語では関数もデータも値を返す「式」とみなす

- 基本的な構成要素
  - 命令型： 命令文
  - 関数型： 式

命令型言語：手続き的

```java
int amount; // 変数の宣言
amount = price * count; // 計算結果の変数への格納
transaction.commit(); // 手続きの呼び出し
```

関数型言語：宣言的

```h
max a b // 関数適用
x + 3 // 算術計算
7 // データ
"abc" // データ
```

- 命令型：命令を実行する
- 関数型：式を評価する

## 特徴3 関数を値として扱える

- 関数型言語では関数を値として扱うことができる
- 関数を引数として渡す仕組みによって、ポリモーフィズムと同様の仕組みをシンプルに実現できる
- 関数を引数として受け取る、あるいは関数を戻り値として返す関数を「高階関数」と呼ぶ

全体の処理は共通で一部の処理だけを状況に応じて入れ替えることができる。これはポリモーフィズムと同様の効果がある。

## 特徴4 関数と引数を柔軟に組み合わせることができる

- 部分適用：2つ以上の引数を持つ関数に一部の引数を与えると、残りの引数を持つ別の関数を作ることができる。この仕組みを「部分適用」と呼ぶ。
- カリー化：「複数の引数を取る関数」を「引数を1つだけ取る関数」を使って順次表現することを「カリー化」と呼ぶ
- 関数合成：「関数の合成」により、複数の関数をまとめて別の関数を作ることができる。

部分適用

```h
add x y = x + y
add 2 3 // 5が返る
add 2 // 「add関数の第1引数xに2が与えられて、残りのyだけを引数にとる関数」が返る。(Haskellでは、この関数を(add 2)と書く)おもしろい。
// 以下でも5が返る
(add 2) 3
```

カリー化：引数が大量にあったとしても、引数を1つずつ適用していけば、最後には引数を1つだけ取る関数として表現できる。

関数の合成

```h
square x = x * x
increment x = x + 1
// 関数の合成
square . increment
square . increment 2 // (2 + 1) * (2 + 1) = 9
square . increment 3 // (3 + 1) * (3 + 1) = 16
// 実行順序。まず引数にincrement関数を適用して1を加え、次にsquare関数を適用して二乗を求める。
```

## 特徴5 副作用を起こさない

- 純粋関数型言語では、変数の内容をあとから変更できない
- 関数型言語では、変数に値や式を設定することを「束縛する」と表現する
- 副作業がない関数は、引数が同じなら戻り値は必ず同じになる。これを「参照透過性」と呼ぶ
- 参照透過性を持つソフトウェアは、テストや保守を容易にし、再利用可能な部品を作りやすくする
- 遅延評価方式では、必要になった時点で初めて関数や式を評価する
- 副作用を起こさないことにより、遅延評価方式を実現できる。(どういう順番で評価しても必ず同じ結果になる)

- 副作用(引数から戻り値を求めること以外の仕事)
  - 変数の変更
  - 外部入出力

参照透過性： 引数が同じならば何回評価しても関数の戻り値は必ず同じなる、という性質のこと

```java
// 遅延評価のJavaサンプルコード実際は、Javaは遅延評価をサポートしていない)

/**
  * @param employee 従業員
  * @param workHours 勤務実績時間
  * @return 給与支払い額
  */
int getSalary(Employee employee, int workHours) {
  // 従業員が一般社員の場合は、勤務実績時間から時間外手当を求めて固定給に加算する
}

getSalary(employee, getWorkHours(employee));

// 通常実行： getWorkHoursを実行した後に、getSalaryを実行し、条件分岐する
// 遅延評価： getSalaryを実行し、条件分岐し、正社員ならgetWorkHoursを実行する
```

## 特徴6 場合分けと再帰でループ処理を記述する

- パターンマッチにより、引数の値に応じた場合分け処理を明示できる
- パターンマッチと再帰を利用することで、簡潔かつ明快にループ処理を記述できる

ループ処理には、パターンマッチと再帰を利用する。

パターンマッチ

```h
convertTab '\t' = " "     // 引数の値がタブ記号だった場合に、半角スペースに変換する
convertTab c = [c]        // 引数がタブ記号以外の場合は、たんに文字列型に変換する
```

階乗を求めるループ処理

javaの場合

```java
int factorial(int n) {
  int result = 1;
  for (int i = n; i > 0; i--) {
    result = result * i;
  }
  return result;
}
```

Haskellの場合

```h
// パターンマッチを使って、関数定義を2つに場合分けしている
factorial 1 = 1 // 引数が1の場合のロジック。1の階乗は1を返す。
// 1以外の自然数の場合のロジック。最後は引数が1のときのロジックが適用される。
factorial n = n * fatorial(n - 1)
```

## 特徴7 コンパイラが型を自動的に推測する

- 関数型言語では関数そのものも型を持つ。関数の型は、引数と戻り値の型で表現する
- 型推論機構を備えた言語では、データや関数の型をコンパイラが自動的に推測する
- 型推論と多相性により、汎用性の高い関数を簡潔かつ安全に記述できる

- 強い型づけ： ソースコードで変数の方宣言を強制する
- 弱い型づけ： 変数の型を明示的に宣言せず、実行時に型判定を行う
- 型推論： 変数や関数の型を宣言しなくても、コンパイラが自動的に型を判定する仕組みのこと

- 多相性： 不特定多数の型に適用できる汎用的な関数を作るためのもの
- 型変数： 引数や戻り値に指定した仮の型
- 多相型： 型変数を使って定義した型のこと

引数に応じて戻り値の型を動的に決定する

```h
// リストの中から先頭の要素を取り出す関数
[a] -> a
// aが型変数
// [a]はリスト
// 数値型のリストが引数ならば数値型、文字列型のリストが引数の場合は文字列型
```

### 特徴と用語

1. 関数でプログラムを組み上げる
  - 関数適用
2. すべての式が値を返す
  - 命令型言語、式、式の評価、ラムダ式
3. 関数を値として扱える
  - 第一級関数、高階関数
4. 関数と引数を柔軟に組み合わせることができる
  - 部分適用、カリー化、関数の合成
5. 副作用を起こさない
  - 副作用、束縛、参照透過性、遅延評価
6. 場合分けと再帰でループ処理を記述する
  - パターンマッチ、再帰
7. コンパイラが型を自動的に推測する
  - 型推論、多相性、多相型、型変数

モナド：純粋関数型言語であっても、画面やネットワークやデータベースなどの外部入出力を実現する必要がある。これを「モナド」で実現している。

## 関数型言語のメリット

- 汎用性の高いプログラムを簡潔に書ける： 高階関数や部分適用などを用いて重複を排除したプログラムを書ける
- 汎用的な再利用部品を簡潔に作れる： 関数を再利用の基本単位である
- 分散並列処理と相性が良い： 参照透過性を持つことは、実行順序に関わらず全体の結果が同じになるため、原理的に並列処理に向いている

## 関数型言語の課題

- 実行時のパフォーマンス。ただし、現在はそれほど大きな課題ではない。
- わかりづらさ

## 関数型言語とオブジェクト指向の関係

グローバル変数問題の解決

- オブジェクト指向言語： 変数と手続きをクラスに「まとめて、隠す」ことで対処する。そして、このクラスがふソフトウェアを構成する基本部品になる。
- 関数型言語： 変数の変更を禁止し、引数と戻り値を使って情報を受け渡すことで、対処する。プログラムは関数のネットワークとして構成し、関数を基本的なソフトウェア部品として全体を組み上げる。

アプローチは根本的に異なっているが、補完し合う関係でもある。

- ハイブリッド言語の登場
- 純粋関数型言語Haskellに型クラスの導入
  - 型クラス：異なるデータ型に共通の関数を適用するために、特定の型にだけ適用できる関数を「メソッド」として定義する「型クラス」を導入